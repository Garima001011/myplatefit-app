<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Dashboard - MyPlateFit</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-card {
            border-radius: 0.75rem;
            box-shadow: 0 8px 16px rgba(0,0,0,0.12);
            height: 100%;
            transition: transform 0.2s;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
    </style>
</head>

<body>
<div class="container mt-5">
    <div class="text-end mb-4">
        <a href="/profile" class="btn btn-outline-primary btn-lg">üë§ My Profile</a>
        <a href="/meal-plan" class="btn btn-outline-success ms-2">üçΩÔ∏è View Meal Plan</a>
    </div>

    <h2 class="text-center text-success mb-4">Welcome, <span th:text="${user.name}">Garima</span>!</h2>

    <!-- Quick Stats Section -->
    <div class="row g-4 mb-4">
        <div class="col-md-2">
            <div class="p-3 bg-white dashboard-card text-center">
                <h6 class="section-header">BMI</h6>
                <h3 class="text-primary" th:text="${bmi}">--</h3>
            </div>
        </div>
        <div class="col-md-2">
            <div class="p-3 bg-white dashboard-card text-center">
                <h6 class="section-header">Today's Calories</h6>
                <h3 class="text-success" th:text="${totalCalories}">0</h3>
            </div>
        </div>
        <div class="col-md-2">
            <div class="p-3 bg-white dashboard-card text-center">
                <h6 class="section-header">Weight Logs</h6>
                <h3 class="text-warning" th:text="${logs.size()}">0</h3>
            </div>
        </div>
        <div class="col-md-2">
            <div class="p-3 bg-white dashboard-card text-center">
                <h6 class="section-header">Meals Logged Today</h6>
                <h3 class="text-info" th:text="${meals.size()}">0</h3>
            </div>
        </div>
        <div class="col-md-2">
            <div class="p-3 bg-white dashboard-card text-center">
                <h6 class="section-header">Recommended Calories</h6>
                <h3 class="text-info" th:text="${recommendedCalories}">0</h3>
            </div>
        </div>
    </div>

    <!-- Weight Log Form -->
    <div class="p-4 bg-white dashboard-card mb-4">
        <h4 class="section-header mb-3">üìä Log Weight</h4>
        <form th:action="@{/addWeight}" th:object="${weightLog}" method="post" class="row g-3">
            <div class="col-md-6">
                <input type="number" th:field="*{weight}" step="0.1" class="form-control" placeholder="Enter weight (kg)" required>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Add</button>
            </div>
        </form>
    </div>

    <!-- Meal Log Form -->
    <div class="p-4 bg-white dashboard-card mb-4">
        <h4 class="section-header mb-3">üçΩÔ∏è Log Meal</h4>
        <form th:action="@{/addMeal}" th:object="${meal}" method="post" class="row g-3">
            <div class="col-md-4 position-relative">
                <input type="text" th:field="*{foodName}" placeholder="e.g. Chicken Breast" class="form-control" id="foodName" autocomplete="off" required>
                <div id="suggestions" class="list-group position-absolute w-100 z-3" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
            <div class="col-md-3">
                <select th:field="*{mealType}" class="form-select" required>
                    <option value="">Select Meal</option>
                    <option value="Breakfast">Breakfast</option>
                    <option value="Lunch">Lunch</option>
                    <option value="Dinner">Dinner</option>
                    <option value="Snack">Snack</option>
                </select>
            </div>
            <div class="col-md-2">
                <input type="number" th:field="*{calories}" placeholder="Calories" class="form-control" required>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-success w-100">Add Meal</button>
            </div>
        </form>
    </div>

    <!-- Chart Section -->
    <div class="p-4 bg-white dashboard-card mb-4">
        <h4 class="section-header mb-3">üìà Trends</h4>
        <div class="row">
            <div class="col-md-6">
                <canvas id="weightChart" height="300"></canvas>
            </div>
            <div class="col-md-6">
                <canvas id="calorieChart" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Logout -->
    <div class="text-center mt-4 mb-5">
        <a href="/logout" class="btn btn-outline-danger">Logout</a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- The full beautiful combined script you already have -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const foodInput = document.getElementById('foodName');
        const calorieInput = document.querySelector('[name="calories"]');
        const suggestionsBox = document.getElementById('suggestions');

        foodInput.addEventListener('input', async () => {
            const query = foodInput.value.trim();
            if (!query || query.length < 2) {
                suggestionsBox.innerHTML = '';
                return;
            }

            const res = await fetch(`/api/suggestions?query=${encodeURIComponent(query)}`);
            const foods = await res.json();

            suggestionsBox.innerHTML = '';
            foods.forEach(item => {
                const div = document.createElement('div');
                div.classList.add('list-group-item', 'list-group-item-action');
                div.textContent = item.description;
                div.dataset.foodName = item.description;

                const energy = item.foodNutrients.find(n => n.nutrientName === 'Energy');
                div.dataset.calories = energy ? Math.round(energy.value) : '';

                div.addEventListener('click', () => {
                    foodInput.value = div.dataset.foodName;
                    calorieInput.value = div.dataset.calories;
                    suggestionsBox.innerHTML = '';
                });

                suggestionsBox.appendChild(div);
            });
        });

        document.addEventListener('click', (e) => {
            if (!suggestionsBox.contains(e.target) && e.target !== foodInput) {
                suggestionsBox.innerHTML = '';
            }
        });

        fetch('/chart-data')
            .then(res => res.json())
            .then(data => {
                const weightCtx = document.getElementById('weightChart').getContext('2d');
                new Chart(weightCtx, {
                    type: 'line',
                    data: {
                        labels: data.weightLogs.map(w => w.date),
                        datasets: [{
                            label: 'Weight (kg)',
                            data: data.weightLogs.map(w => w.weight),
                            borderColor: '#2e7d32',
                            backgroundColor: 'rgba(46,125,50,0.2)',
                            fill: true,
                            tension: 0.4
                        }]
                    }
                });

                const calorieCtx = document.getElementById('calorieChart').getContext('2d');
                new Chart(calorieCtx, {
                    type: 'bar',
                    data: {
                        labels: data.calorieLogs.map(c => c.date),
                        datasets: [{
                            label: 'Calories',
                            data: data.calorieLogs.map(c => c.calories),
                            backgroundColor: 'rgba(56,142,60, 0.7)'
                        }]
                    }
                });
            });
    });
</script>

</body>
</html>
